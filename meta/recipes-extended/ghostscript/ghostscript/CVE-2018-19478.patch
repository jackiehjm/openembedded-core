From 0a7e5a1c309fa0911b892fa40996a7d55d90bace Mon Sep 17 00:00:00 2001
From: Ken Sharp <ken.sharp@artifex.com>
Date: Wed, 3 Oct 2018 17:00:28 +0100
Subject: [PATCH] PDF interpreter - limit page tree recusrsion checking

Bug #699856 "Attempting to open a carefully crafted PDF file results in long-running computation"

A sufficiently bad page tree can lead to us taking significant amounts
of time when checking the tree for recursion.

We can limit this by noting the number of pages in the root node
(given by /Count) and stopping the recursion check when we have
encountered that many leaf nodes.

Our other recursion checks work by reading the resources from the page
nodes and so are unaffected by this.

CVE: CVE-2018-19478
Upstream-Status: Backport [git://git.ghostscript.com/ghostpdl.git]

Signed-off-by: Ovidiu Panait <ovidiu.panait@windriver.com>
---
 Resource/Init/pdf_main.ps | 38 +++++++++++++++++++++++---------------
 1 file changed, 23 insertions(+), 15 deletions(-)

diff --git a/Resource/Init/pdf_main.ps b/Resource/Init/pdf_main.ps
index 09f87353c..4d59d9c53 100644
--- a/Resource/Init/pdf_main.ps
+++ b/Resource/Init/pdf_main.ps
@@ -1952,22 +1952,30 @@ currentdict /xref-char-dict undef
   Trailer /Root knownoget {
     /Pages knownoget {
       10 dict begin
+      /Count pdfpagecount def
       /verify_page_tree_recursive {
-        dup 1 def
-        dup /Kids knownoget {
-          { oforce
-            dup //null ne {
-              currentdict 1 index known {
-                (   **** Error: there's a loop in the Pages tree. Giving up.\n) pdfformaterror
-                /verify_page_tree cvx /syntaxerror signalerror
-              } if
-              verify_page_tree_recursive
-            } {
-              pop
-            } ifelse
-          } forall
-        } if
-        currentdict exch undef
+        Count 0 gt {
+          dup 1 def
+          dup /Kids knownoget {
+            { oforce
+              dup //null ne {
+                currentdict 1 index known {
+                  (   **** Error: there's a loop in the Pages tree. Giving up.\n) pdfformaterror
+                  /verify_page_tree cvx /syntaxerror signalerror
+                } if
+                verify_page_tree_recursive
+              } {
+                pop
+              } ifelse
+            } forall
+          } {
+            /Count Count 1 sub def
+          }ifelse
+          currentdict exch undef
+          } {
+            pop
+            (   **** Error: Too many pages in Page tree.\n) pdfformaterror
+        } ifelse
       } def
       verify_page_tree_recursive
       end
-- 
2.13.3

