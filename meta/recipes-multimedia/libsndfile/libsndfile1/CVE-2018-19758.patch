From 42132c543358cee9f7c3e9e9b15bb6c1063a608e Mon Sep 17 00:00:00 2001
From: Erik de Castro Lopo <erikd@mega-nerd.com>
Date: Tue, 1 Jan 2019 20:11:46 +1100
Subject: [PATCH] src/wav.c: Fix heap read overflow

This is CVE-2018-19758.

Closes: https://github.com/erikd/libsndfile/issues/435

Upstream-Status: Backport[master]
https://github.com/erikd/libsndfile/commit/42132c543358cee9f7c3e9e9b15bb6c1063a608e

Signed-off-by: Yue Tao <yue.tao@windriver.com>
---
 src/wav.c |    6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

Index: libsndfile-1.0.28/src/wav.c
===================================================================
--- libsndfile-1.0.28.orig/src/wav.c
+++ libsndfile-1.0.28/src/wav.c
@@ -1,5 +1,5 @@
 /*
-** Copyright (C) 1999-2018 Erik de Castro Lopo <erikd@mega-nerd.com>
+** Copyright (C) 1999-2019 Erik de Castro Lopo <erikd@mega-nerd.com>
 ** Copyright (C) 2004-2005 David Viens <davidv@plogue.com>
 **
 ** This program is free software; you can redistribute it and/or modify
@@ -1094,6 +1094,8 @@ wav_write_header (SF_PRIVATE *psf, int c
 		psf_binheader_writef (psf, "44", 0, 0) ; /* SMTPE format */
 		psf_binheader_writef (psf, "44", psf->instrument->loop_count, 0) ;
 
+		/* Loop count is signed 16 bit number so we limit it range to something sensible. */
+		psf->instrument->loop_count &= 0x7fff ;
 		for (tmp = 0 ; tmp < psf->instrument->loop_count ; tmp++)
 		{	int type ;
 
@@ -1360,7 +1362,7 @@ wav_read_smpl_chunk (SF_PRIVATE *psf, ui
 		} ;
 
 	psf->instrument->basenote = note ;
-	psf->instrument->detune = (int8_t)(pitch / (0x40000000 / 25.0) + 0.5) ;
+	psf->instrument->detune = (int8_t) (pitch / (0x40000000 / 25.0) + 0.5) ;
 	psf->instrument->gain = 1 ;
 	psf->instrument->velocity_lo = psf->instrument->key_lo = 0 ;
 	psf->instrument->velocity_hi = psf->instrument->key_hi = 127 ;
