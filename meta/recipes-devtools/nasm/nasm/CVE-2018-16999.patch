From 980dd658b521afe4a688c4195410c4449a8e2468 Mon Sep 17 00:00:00 2001
From: Cyrill Gorcunov <gorcunov@gmail.com>
Date: Sun, 14 Oct 2018 19:25:32 +0300
Subject: [PATCH] preproc: expand_smacro -- Fix nil dereference on error path

When error happened earlier we might have a.mac already
handled and set to nil.

https://bugzilla.nasm.us/show_bug.cgi?id=3392508

Signed-off-by: Cyrill Gorcunov <gorcunov@gmail.com>

CVE: CVE-2018-16999
Upstream-Status: Backport[master]
https://repo.or.cz/nasm.git/commit/980dd658b521afe4a688c4195410c4449a8e2468

Signed-off-by: Yue Tao <yue.tao@windriver.com>
---
 asm/preproc.c |    4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

Index: nasm-2.13.03/asm/preproc.c
===================================================================
--- nasm-2.13.03.orig/asm/preproc.c
+++ nasm-2.13.03/asm/preproc.c
@@ -4469,7 +4469,9 @@ again:
         }
 
         if (tline->type == TOK_SMAC_END) {
-            tline->a.mac->in_progress = false;
+            /* On error path it might already be dropped */
+            if (tline->a.mac)
+                tline->a.mac->in_progress = false;
             tline = delete_Token(tline);
         } else {
             t = *tail = tline;
