From 661f723d39e03ca6eb05d7376a43ca33db478354 Mon Sep 17 00:00:00 2001
From: Cyrill Gorcunov <gorcunov@gmail.com>
Date: Sun, 28 Oct 2018 20:39:34 +0300
Subject: [PATCH] preproc: Fix out of bound access on malformed input

A fuzzer revealed a problem in preproc code.

https://bugzilla.nasm.us/show_bug.cgi?id=3392521

Reported-by: ganshuitao <ganshuitao@gmail.com>
Signed-off-by: Cyrill Gorcunov <gorcunov@gmail.com>

CVE: CVE-2018-19214
Upstream-Status: Backport[master]
https://repo.or.cz/nasm.git/commit/661f723d39e03ca6eb05d7376a43ca33db478354

Signed-off-by: Yue Tao <yue.tao@windriver.com>
---
 asm/preproc.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

Index: nasm-2.13.03/asm/preproc.c
===================================================================
--- nasm-2.13.03.orig/asm/preproc.c
+++ nasm-2.13.03/asm/preproc.c
@@ -4000,7 +4000,7 @@ static Token *expand_mmac_params(Token *
     thead = NULL;
 
     while (tline) {
-        if (tline->type == TOK_PREPROC_ID &&
+        if (tline->type == TOK_PREPROC_ID && tline->text && tline->text[0] &&
             (((tline->text[1] == '+' || tline->text[1] == '-') && tline->text[2])   ||
               (tline->text[1] >= '0' && tline->text[1] <= '9')                      ||
                tline->text[1] == '%')) {
