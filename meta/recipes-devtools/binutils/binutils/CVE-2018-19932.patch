From beab453223769279cc1cef68a1622ab8978641f7 Mon Sep 17 00:00:00 2001
From: Nick Clifton <nickc@redhat.com>
Date: Fri, 30 Nov 2018 11:43:12 +0000
Subject: [PATCH] Remove an abort in the bfd library and add a check for an
 integer overflow when mapping sections to segments.

	PR 23932
	* elf.c (IS_CONTAINED_BY_LMA): Add a check for a negative section
	size.
	(rewrite_elf_program_header): If no sections are mapped into a
	segment return an error.

CVE: CVE-2018-19932
Upstream-Status: Backport[master]
https://sourceware.org/git/gitweb.cgi?p=binutils-gdb.git;h=beab453223769279cc1cef68a1622ab8978641f7
---
 bfd/ChangeLog |    8 ++++++++
 bfd/elf.c     |   11 ++++++++++-
 2 files changed, 18 insertions(+), 1 deletion(-)

diff --git a/bfd/ChangeLog b/bfd/ChangeLog
index 8f455ae..6ea4835 100644
--- a/bfd/ChangeLog
+++ b/bfd/ChangeLog
@@ -6,6 +6,14 @@
 
 2018-11-30  Nick Clifton  <nickc@redhat.com>
 
+	PR 23932
+	* elf.c (IS_CONTAINED_BY_LMA): Add a check for a negative section
+	size.
+	(rewrite_elf_program_header): If no sections are mapped into a
+	segment return an error.
+
+2018-11-30  Nick Clifton  <nickc@redhat.com>
+
 	* elfcode.h (elf_object_p): Check for corrupt input files with
 	more program headers than can actually fit in the file.
 
diff --git a/bfd/elf.c b/bfd/elf.c
index 604971d..79a76be 100644
--- a/bfd/elf.c
+++ b/bfd/elf.c
@@ -6592,6 +6592,7 @@ rewrite_elf_program_header (bfd *ibfd, b
      the given segment.  LMA addresses are compared.  */
 #define IS_CONTAINED_BY_LMA(section, segment, base)			\
   (section->lma >= base							\
+   && (section->lma + SECTION_SIZE (section, segment) >= section->lma)	\
    && (section->lma + SECTION_SIZE (section, segment)			\
        <= SEGMENT_END (segment, base)))
 
@@ -7114,7 +7115,15 @@ rewrite_elf_program_header (bfd *ibfd, b
 		suggested_lma = output_section;
 	    }
 
-	  BFD_ASSERT (map->count > 0);
+	  /* PR 23932.  A corrupt input file may contain sections that cannot
+	     be assigned to any segment - because for example they have a
+	     negative size - or segments that do not contain any sections.  */
+	  if (map->count == 0)
+	    {
+	      bfd_set_error (bfd_error_bad_value);
+	      free (sections);
+	      return FALSE;
+	    }
 
 	  /* Add the current segment to the list of built segments.  */
 	  *pointer_to_map = map;
-- 
1.7.9.5

