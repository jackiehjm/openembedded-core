From ab419ddbb2cdd17ca83618990f2cacf904ce1d61 Mon Sep 17 00:00:00 2001
From: Alan Modra <amodra@gmail.com>
Date: Tue, 23 Oct 2018 18:29:24 +1030
Subject: [PATCH] PR23804, buffer overflow in sec_merge_hash_lookup

	PR 23804
	* merge.c (_bfd_add_merge_section): Don't attempt to merge
	sections where size is not a multiple of entsize.

CVE: CVE-2018-18605
Upstream-Status: Backport[master]
https://sourceware.org/git/gitweb.cgi?p=binutils-gdb.git;h=ab419ddbb2cdd17ca83618990f2cacf904ce1d61
---
 bfd/ChangeLog |    6 ++++++
 bfd/merge.c   |    3 +++
 2 files changed, 9 insertions(+)

diff --git a/bfd/ChangeLog b/bfd/ChangeLog
index 31ff3d6..da423b1 100644
--- a/bfd/ChangeLog
+++ b/bfd/ChangeLog
@@ -17,6 +17,12 @@
 	* elfcode.h (elf_object_p): Check for corrupt input files with
 	more program headers than can actually fit in the file.
 
+2018-10-23  Alan Modra  <amodra@gmail.com>
+
+	PR 23804
+	* merge.c (_bfd_add_merge_section): Don't attempt to merge
+	sections where size is not a multiple of entsize.
+
 2018-09-20  Alan Modra  <amodra@gmail.com>
 
 	PR 23685
diff --git a/bfd/merge.c b/bfd/merge.c
index 7904552..5e3bba0 100644
--- a/bfd/merge.c
+++ b/bfd/merge.c
@@ -376,6 +376,9 @@ _bfd_add_merge_section (bfd *abfd, void
       || sec->entsize == 0)
     return TRUE;
 
+  if (sec->size % sec->entsize != 0)
+    return TRUE;
+
   if ((sec->flags & SEC_RELOC) != 0)
     {
       /* We aren't prepared to handle relocations in merged sections.  */
-- 
1.7.9.5

