From 5f60af5d24d181371d67534fa273dd221df20c07 Mon Sep 17 00:00:00 2001
From: Nick Clifton <nickc@redhat.com>
Date: Fri, 30 Nov 2018 11:45:33 +0000
Subject: [PATCH] Fix a memory exhaustion bug when attempting to allocate room
 for an impossible number of program headers.

	* elfcode.h (elf_object_p): Check for corrupt input files with
	more program headers than can actually fit in the file.

CVE: CVE-2018-19931
Upstream-Status: Backport[master]
https://sourceware.org/git/gitweb.cgi?p=binutils-gdb.git;h=5f60af5d24d181371d67534fa273dd221df20c07
---
 bfd/ChangeLog |    5 +++++
 bfd/elfcode.h |    5 +++++
 2 files changed, 10 insertions(+)

diff --git a/bfd/ChangeLog b/bfd/ChangeLog
index 6ea4835..f99b085 100644
--- a/bfd/ChangeLog
+++ b/bfd/ChangeLog
@@ -4,6 +4,11 @@
 	* syms.c (_bfd_generic_read_minisymbols): Free syms before
 	returning with zero symcount.
 
+2018-11-30  Nick Clifton  <nickc@redhat.com>
+
+	* elfcode.h (elf_object_p): Check for corrupt input files with
+	more program headers than can actually fit in the file.
+
 2018-09-20  Alan Modra  <amodra@gmail.com>
 
 	PR 23685
diff --git a/bfd/elfcode.h b/bfd/elfcode.h
index f224c8b..16ed8e5 100644
--- a/bfd/elfcode.h
+++ b/bfd/elfcode.h
@@ -776,6 +776,11 @@ elf_object_p (bfd *abfd)
       if (i_ehdrp->e_phnum > ((bfd_size_type) -1) / sizeof (*i_phdr))
 	goto got_wrong_format_error;
 #endif
+      /* Check for a corrupt input file with an impossibly large number
+	 of program headers.  */
+      if (bfd_get_file_size (abfd) > 0
+	  && i_ehdrp->e_phnum > bfd_get_file_size (abfd))
+	goto got_no_match;
       amt = (bfd_size_type) i_ehdrp->e_phnum * sizeof (*i_phdr);
       elf_tdata (abfd)->phdr = (Elf_Internal_Phdr *) bfd_alloc (abfd, amt);
       if (elf_tdata (abfd)->phdr == NULL)
-- 
1.7.9.5

