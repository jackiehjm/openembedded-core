# HG changeset patch
# User Sam Lantinga <slouken@libsdl.org>
# Date 1550505033 28800
#      Mon Feb 18 07:50:33 2019 -0800
# Node ID 07c39cbbeacf30ee61aab5e32d9a6f0eb35b95d2
# Parent  587922004ea0caba56eca653d415332327dfdca1
Fixed bug 4500 - Heap-Buffer Overflow in Map1toN pertaining to SDL_pixels.c

Petr Pisar

The reproducer has these data in BITMAPINFOHEADER:

biSize = 40
biBitCount = 8
biClrUsed = 131075

SDL_LoadBMP_RW() function passes biBitCount as a color depth to SDL_CreateRGBSurface(), thus 256-color pallete is allocated. But then biClrUsed colors are read from a file and stored into the palette. SDL_LoadBMP_RW should report an error if biClrUsed is greater than 2^biBitCount.

CVE: CVE-2019-7636
Upstream-Status: Backport[master]
https://hg.libsdl.org/SDL/rev/07c39cbbeacf

diff -r 587922004ea0 -r 07c39cbbeacf src/video/SDL_bmp.c
--- a/src/video/SDL_bmp.c	Sun Feb 17 16:20:23 2019 +0100
+++ b/src/video/SDL_bmp.c	Mon Feb 18 07:50:33 2019 -0800
@@ -313,6 +313,10 @@
         SDL_assert(biBitCount <= 8);
         if (biClrUsed == 0) {
             biClrUsed = 1 << biBitCount;
+		} else if (biClrUsed > (1 << biBitCount)) {
+			SDL_SetError("BMP file has an invalid number of colors");
+			was_error = SDL_TRUE;
+			goto done;
         }
         if ((int) biClrUsed > palette->ncolors) {
             SDL_Color *colors;
